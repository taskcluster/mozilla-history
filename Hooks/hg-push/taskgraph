{
  "bindings": [
    {
      "exchange": "exchange/hgpushes/v2",
      "routingKeyPattern": "ci/taskgraph"
    }
  ],
  "hookGroupId": "hg-push",
  "hookId": "taskgraph",
  "metadata": {
    "description": "*DO NOT EDIT* - This resource is configured automatically by [ci-admin](https://hg.mozilla.org/ci/ci-configuration).\n\nOn-push task for repository https://hg.mozilla.org/ci/taskgraph.\n\nThis hook listens to pulse messages from `hg.mozilla.org` and creates\na task which quickly creates a decision task when such a message arrives.\n",
    "name": "hg-push/taskgraph",
    "owner": "release+tc-hooks@mozilla.com"
  },
  "schedule": [],
  "task": {
    "tags": {},
    "extra": {},
    "routes": [
      "index.hg-push.v1.taskgraph.revision.${payload.payload.data.heads[0]}",
      "index.hg-push.v1.taskgraph.pushlog-id.${payload.payload.data.pushlog_pushes[0].pushid}"
    ],
    "scopes": [
      "assume:repo:hg.mozilla.org/ci/taskgraph:branch:*"
    ],
    "expires": {
      "$fromNow": "3 days"
    },
    "payload": {
      "env": {
        "PULSE_MESSAGE": {
          "$json": {
            "$eval": "payload"
          }
        }
      },
      "image": "mozillareleases/build-decision:c8c65816c6f80d7f6466a8561549a5d9bc21db7f@sha256:97b21a2cf55f323127c1ec3f7d1a73a672efa5bfc0fd2aa11f6b348b6aac7d67",
      "command": [
        "hg-push",
        "--repo-url",
        "https://hg.mozilla.org/ci/taskgraph",
        "--project",
        "taskgraph",
        "--level",
        "3",
        "--trust-domain",
        "taskgraph",
        "--repository-type",
        "hg"
      ],
      "features": {
        "taskclusterProxy": true
      },
      "maxRunTime": 600
    },
    "retries": 5,
    "deadline": {
      "$fromNow": "30 minutes"
    },
    "metadata": {
      "in": {
        "name": "On-Push task for https://hg.mozilla.org/ci/taskgraph",
        "owner": "mozilla-taskcluster-maintenance@mozilla.com",
        "source": "https://firefox-ci-tc.services.mozilla.com/hooks/hg-push/taskgraph",
        "description": "${description}"
      },
      "$let": {
        "description": {
          "$if": "firedBy == \"triggerHook\"",
          "else": "Fired by ${firedBy}",
          "then": "Fired by triggerHook call from ${clientId}"
        }
      }
    },
    "priority": "highest",
    "workerType": "build-decision",
    "schedulerId": "taskgraph-level-3",
    "provisionerId": "infra"
  },
  "triggerSchema": {
    "type": "object",
    "required": [
      "payload"
    ],
    "properties": {
      "_meta": {},
      "payload": {
        "type": "object",
        "required": [
          "type",
          "data"
        ],
        "properties": {
          "data": {
            "type": "object",
            "required": [
              "repo_url",
              "heads",
              "pushlog_pushes"
            ],
            "properties": {
              "heads": {
                "type": "array",
                "items": [
                  {
                    "type": "string",
                    "pattern": "^[0-9a-z]{40}$"
                  }
                ]
              },
              "source": {},
              "repo_url": {
                "enum": [
                  "https://hg.mozilla.org/ci/taskgraph"
                ],
                "default": "https://hg.mozilla.org/ci/taskgraph"
              },
              "pushlog_pushes": {
                "type": "array",
                "items": [
                  {
                    "type": "object",
                    "required": [
                      "time",
                      "pushid",
                      "user"
                    ],
                    "properties": {
                      "time": {
                        "type": "integer",
                        "default": 0
                      },
                      "user": {
                        "type": "string",
                        "format": "email",
                        "default": "nobody@mozilla.com"
                      },
                      "pushid": {
                        "type": "integer",
                        "default": 0
                      },
                      "push_json_url": {
                        "type": "string"
                      },
                      "push_full_json_url": {
                        "type": "string"
                      }
                    },
                    "additionalProperties": false
                  }
                ]
              }
            },
            "additionalProperties": false
          },
          "type": {
            "enum": [
              "changegroup.1"
            ],
            "default": "changegroup.1"
          }
        },
        "description": "Hg push payload - see https://mozilla-version-control-tools.readthedocs.io/en/latest/hgmo/notifications.html#pulse-notifications.",
        "additionalProperties": false
      }
    },
    "additionalProperties": false
  }
}
